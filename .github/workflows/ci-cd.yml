name: CI/CD - Build & Deploy with Migrations
on:
  push:
    branches: [ main ]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and Push Image
        uses: docker/build-push-action@v5
        with:
          context: ./app
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/familytree:latest
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code (for migrations)
        uses: actions/checkout@v4
      
      - name: Copy migration files to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: "db/*.sql"
          target: "/tmp/deploy-migrations/"
          strip_components: 0
      
      - name: Deploy to EC2 with Migrations
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script: |
            set -e
            echo "=== Starting Deployment ==="
            
            # Ensure DB folder exists on instance (persistent storage)
            sudo mkdir -p /var/lib/familytreevault/data
            
            DB_PATH="/var/lib/familytreevault/data/demoDB.sqlite"
            MIGRATIONS_DIR="/tmp/deploy-migrations/db"
            
            # If DB file doesn't exist, create it
            if [ ! -f "$DB_PATH" ]; then
              echo "Creating empty SQLite DB..."
              sudo sqlite3 "$DB_PATH" "VACUUM;"
              sudo chown ubuntu:ubuntu "$DB_PATH"
              sudo chmod 644 "$DB_PATH"
            fi
            
            echo "=== Running Database Migrations ==="
            
            # Create migrations tracking table if it doesn't exist
            sudo sqlite3 "$DB_PATH" <<'EOF'
            CREATE TABLE IF NOT EXISTS schema_migrations (
              id INTEGER PRIMARY KEY AUTOINCREMENT,
              filename TEXT NOT NULL UNIQUE,
              applied_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            EOF
            
            # Get list of already applied migrations
            APPLIED_MIGRATIONS=$(sudo sqlite3 "$DB_PATH" "SELECT filename FROM schema_migrations ORDER BY filename;")
            echo "Already applied migrations:"
            echo "$APPLIED_MIGRATIONS"
            
            # Check if migrations directory exists and has files
            if [ -d "$MIGRATIONS_DIR" ] && [ "$(ls -A $MIGRATIONS_DIR/*.sql 2>/dev/null)" ]; then
              echo "Found migration files, processing..."
              
              # Process each SQL file in sorted order
              for sql_file in $(ls "$MIGRATIONS_DIR"/*.sql | sort); do
                FILENAME=$(basename "$sql_file")
                
                # Check if this migration has already been applied
                if echo "$APPLIED_MIGRATIONS" | grep -q "^$FILENAME$"; then
                  echo "⏭️  Skipping already applied: $FILENAME"
                else
                  echo "▶️  Applying migration: $FILENAME"
                  
                  # Apply the migration
                  if sudo sqlite3 "$DB_PATH" < "$sql_file"; then
                    # Record the migration
                    sudo sqlite3 "$DB_PATH" "INSERT INTO schema_migrations (filename) VALUES ('$FILENAME');"
                    echo "✅ Successfully applied: $FILENAME"
                  else
                    echo "❌ Failed to apply migration: $FILENAME"
                    exit 1
                  fi
                fi
              done
              
              echo "✅ All migrations completed successfully"
            else
              echo "ℹ️  No migration files found in $MIGRATIONS_DIR"
            fi
            
            # Fix ownership after migrations
            sudo chown ubuntu:ubuntu "$DB_PATH"
            sudo chmod 644 "$DB_PATH"
            
            echo "=== Updating Container ==="
            
            # Pull latest image
            sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/familytree:latest
            
            # Stop old container safely
            sudo docker stop familytreevault || true
            sudo docker rm familytreevault || true
            
            echo "=== Starting New Container ==="
            sudo docker run -d \
              --name familytreevault \
              -p 80:80 \
              --restart always \
              -e SQLITE_DB_PATH="/app/data/demoDB.sqlite" \
              -v /var/lib/familytreevault/data:/app/data \
              -u 1000:1000 \
              ${{ secrets.DOCKERHUB_USERNAME }}/familytree:latest
            
            # Wait for container to be healthy
            echo "=== Waiting for application to start ==="
            sleep 5
            
            # Check if container is running
            if sudo docker ps | grep -q familytreevault; then
              echo "✅ Container is running"
              
              # Optional: Health check
              if curl -f http://localhost/api/health > /dev/null 2>&1; then
                echo "✅ Application health check passed"
              else
                echo "⚠️  Health check endpoint not responding (may still be starting)"
              fi
            else
              echo "❌ Container failed to start"
              sudo docker logs familytreevault
              exit 1
            fi
            
            # Cleanup temporary migration files
            rm -rf /tmp/deploy-migrations
            
            echo "=== Deployment Complete ==="
