---
- name: Configure web VM (SQLite variant)
  hosts: web
  become: yes

  vars:
    # Change these before running
    dbadmin_user: "dbadmin"                # kept for compatibility in templates, SQLite has no users
    dbadmin_password: "Admin@123"          # kept for compatibility; SQLite doesn't use passwords
    # Docker image and app container name
    app_image: "mdhake1dbs/demo-app"
    app_container_name: "demo-app"
    # SQLite database filename (will be placed under db_data_dir)
    target_db_name: "demoDB.sqlite"
    db_data_dir: "/var/lib/{{ app_container_name }}/data"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install common prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repo (Ubuntu-specific)
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: latest
        update_cache: yes

    - name: Ensure docker service is enabled and started
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # -----------------------
    # SQLite installation & setup
    # -----------------------

    - name: Install sqlite3 and dev packages
      apt:
        name:
          - sqlite3
          - libsqlite3-dev
        state: present
        update_cache: yes

    - name: Ensure DB data directory exists
      file:
        path: "{{ db_data_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'

    - name: Ensure remote SQL script directory exists
      file:
        path: /tmp/db_init
        state: directory
        mode: '0755'

    - name: Gather SQL files from local db directory (sorted)
      set_fact:
        sql_files_local: "{{ lookup('fileglob', 'db/*.sql', wantlist=True) | sort }}"

    - name: Copy SQL scripts to target (preserving order)
      copy:
        src: "{{ item }}"
        dest: "/tmp/db_init/{{ item | basename }}"
        mode: '0644'
      loop: "{{ sql_files_local }}"

    - name: List copied SQL files (debug)
      debug:
        msg: "Copied SQL file: /tmp/db_init/{{ item | basename }}"
      loop: "{{ sql_files_local }}"
      changed_when: false

    - name: Create (empty) SQLite database file if missing
      command: "sqlite3 {{ db_data_dir }}/{{ target_db_name }} '.databases'"
      args:
        creates: "{{ db_data_dir }}/{{ target_db_name }}"

    - name: Run SQL scripts against SQLite DB in order
      # SQLite doesn't have separate users/servers â€” run all scripts against the DB file.
      shell: |
        sqlite3 {{ db_data_dir }}/{{ target_db_name }} < /tmp/db_init/{{ item | basename }}
      loop: "{{ sql_files_local }}"
      register: sqlite_runs
      failed_when: sqlite_runs is failed
      no_log: false

    - name: "Debug: DB initialization finished"
      debug:
        msg:
          - "DB init completed (SQLite file: {{ db_data_dir }}/{{ target_db_name }})."
          - "Executed {{ sql_files_local | length }} script(s)."
      changed_when: false

    # -----------------------
    # Docker: pull & run app
    # -----------------------

    - name: Pull app image from Docker Hub (if using public image)
      docker_image:
        name: "{{ app_image }}"
        source: pull

    - name: Run container
      docker_container:
        name: "{{ app_container_name }}"
        image: "{{ app_image }}"
        state: started
        restart_policy: always
        ports:
          - "80:80"
        volumes:
          - "{{ db_data_dir }}:/app/data"   # mount DB directory into the container (adjust path inside container if needed)

