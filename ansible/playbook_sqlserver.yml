---
- name: Configure web VM
  hosts: web
  become: yes

  vars:
    # Change these before running
    mssql_sa_password: "YourStrong!SApwd"
    dbadmin_user: "dbadmin"
    dbadmin_password: "Admin@123"
    # Docker image and app container name
    app_image: "mdhake1dbs/demo-app"
    app_container_name: "demo-app"
    # Default target DB name for running remaining scripts (if needed)
    target_db_name: "demoDB"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install common prerequisites
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - software-properties-common
          - gnupg
          - lsb-release
        state: present
        update_cache: yes

    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present

    - name: Add Docker repo (Ubuntu-specific)
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_lsb.codename }} stable"
        state: present

    - name: Install Docker
      apt:
        name: docker-ce
        state: latest
        update_cache: yes

    - name: Ensure docker service is enabled and started
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add ubuntu user to docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    # -----------------------
    # Microsoft SQL Server install & config (auto-detect Ubuntu version)
    # -----------------------

    - name: Add Microsoft GPG key (packages.microsoft.com)
      apt_key:
        url: https://packages.microsoft.com/keys/microsoft.asc
        state: present

    - name: Set Microsoft repo base path using detected Ubuntu version
      set_fact:
        mssql_ubuntu_version: "{{ ansible_distribution_version }}"
      # (ansible_distribution_version is e.g. '22.04' on Ubuntu 22.04)

    - name: Add Microsoft SQL Server repo (uses detected Ubuntu version)
      apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/ubuntu/{{ mssql_ubuntu_version }}/mssql-server-2022 {{ ansible_lsb.codename }} main"
        filename: 'mssql-server-2022'
        state: present

    - name: Add Microsoft tools repository (for mssql-tools) using detected version
      apt_repository:
        repo: "deb [arch=amd64] https://packages.microsoft.com/ubuntu/{{ mssql_ubuntu_version }}/prod {{ ansible_lsb.codename }} main"
        filename: 'msprod'
        state: present

    - name: Ensure 'universe' repository is enabled (required for some deps)
      apt_repository:
        repo: "deb http://archive.ubuntu.com/ubuntu {{ ansible_lsb.codename }} universe"
        state: present

    - name: Update apt cache after adding repos
      apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install MS SQL Server and dependencies
      apt:
        name:
          - mssql-server
          - unixodbc
          - unixodbc-dev
          - libkrb5-3
          - libldap-2.5-0
          - libssl3
        state: present
      register: install_mssql
      failed_when: install_mssql is failed

    - name: Run mssql-conf non-interactive setup (configure SA password & accept EULA)
      shell: |
        MSSQL_SA_PASSWORD='{{ mssql_sa_password }}' MSSQL_PID='Developer' /opt/mssql/bin/mssql-conf -n setup
      args:
        creates: /var/opt/mssql/bin/sqlservr
      register: mssql_setup
      no_log: true

    - name: Ensure mssql service is enabled and started
      systemd:
        name: mssql-server
        enabled: yes
        state: started

    - name: Wait for SQL Server to accept connections (retry)
      wait_for:
        host: 127.0.0.1
        port: 1433
        delay: 5
        timeout: 180
        state: started

    - name: Install mssql-tools (sqlcmd) package
      apt:
        name:
          - mssql-tools
          - unixodbc-dev
        state: present
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Add /opt/mssql-tools/bin to PATH permanently via /etc/profile.d
      copy:
        dest: /etc/profile.d/mssql-tools.sh
        content: |
          # Added by Ansible: include mssql-tools in PATH
          if [ -d /opt/mssql-tools/bin ]; then
            export PATH="$PATH:/opt/mssql-tools/bin"
          fi
        mode: '0644'

    - name: Create symlink for sqlcmd so it's immediately available in non-login shells
      file:
        src: /opt/mssql-tools/bin/sqlcmd
        dest: /usr/local/bin/sqlcmd
        state: link
        force: yes

    - name: Ensure symlink is executable
      file:
        path: /usr/local/bin/sqlcmd
        mode: '0755'

    - name: Create sysadmin login '{{ dbadmin_user }}' and make it sysadmin (using SA)
      shell: |
        /usr/local/bin/sqlcmd -S localhost -U SA -P '{{ mssql_sa_password }}' -Q "IF NOT EXISTS (SELECT 1 FROM sys.server_principals WHERE name = N'{{ dbadmin_user }}')
        BEGIN
            CREATE LOGIN {{ dbadmin_user }} WITH PASSWORD = N'{{ dbadmin_password }}';
            ALTER SERVER ROLE [sysadmin] ADD MEMBER {{ dbadmin_user }};
        END"
      register: create_dbadmin
      no_log: true
      environment:
        PATH: "{{ ansible_env.PATH }}:/opt/mssql-tools/bin"

    - name: Verify dbadmin can connect (quick check)
      shell: |
        /usr/local/bin/sqlcmd -S localhost -U {{ dbadmin_user }} -P '{{ dbadmin_password }}' -Q "SELECT SUSER_SNAME();"
      register: verify_dbadmin
      failed_when: verify_dbadmin.rc != 0
      changed_when: false
      no_log: true
      environment:
        PATH: "{{ ansible_env.PATH }}:/opt/mssql-tools/bin"

    - name: Show verification message
      debug:
        msg: "dbadmin connection verified (SQL Server reachable)."

    # ----------------------------------------------------
    # Copy & run DB scripts from repo/db on target machine
    # ----------------------------------------------------

    - name: Ensure remote SQL script directory exists
      file:
        path: /tmp/db_init
        state: directory
        mode: '0755'

    - name: Gather SQL files from local db directory (sorted)
      set_fact:
        sql_files_local: "{{ lookup('fileglob', 'db/*.sql', wantlist=True) | sort }}"

    - name: Copy SQL scripts to target (preserving order)
      copy:
        src: "{{ item }}"
        dest: "/tmp/db_init/{{ item | basename }}"
        mode: '0644'
      loop: "{{ sql_files_local }}"

    - name: List copied SQL files (debug)
      debug:
        msg: "Copied SQL file: /tmp/db_init/{{ item | basename }}"
      loop: "{{ sql_files_local }}"
      changed_when: false

    - name: Run first script (create DB/login/user) as SA
      shell: |
        /usr/local/bin/sqlcmd -S localhost -U SA -P '{{ mssql_sa_password }}' -i /tmp/db_init/{{ sql_files_local[0] | basename }} -b
      register: run_first
      failed_when: run_first.rc != 0
      no_log: true
      environment:
        PATH: "{{ ansible_env.PATH }}:/opt/mssql-tools/bin"

    - name: Run remaining scripts (schema / seed) as dbadmin
      vars:
        remaining_sqls: "{{ sql_files_local[1:] }}"
      when: sql_files_local | length > 1
      block:
        - name: Execute SQL files one-by-one as dbadmin
          shell: |
            /usr/local/bin/sqlcmd -S localhost -U {{ dbadmin_user }} -P '{{ dbadmin_password }}' -d {{ target_db_name }} -i /tmp/db_init/{{ item | basename }} -b
          loop: "{{ remaining_sqls }}"
          register: run_remaining
          failed_when: run_remaining.rc != 0
          no_log: true
          environment:
            PATH: "{{ ansible_env.PATH }}:/opt/mssql-tools/bin"

    - name: "Debug: DB initialization finished"
      debug:
        msg: "DB init completed."
      changed_when: false

    # -----------------------
    # Docker: pull & run app
    # -----------------------

    - name: Pull app image from Docker Hub (if using public image)
      docker_image:
        name: "{{ app_image }}"
        source: pull

    - name: Run container
      docker_container:
        name: "{{ app_container_name }}"
        image: "{{ app_image }}"
        state: started
        restart_policy: always
        ports:
          - "80:80"

